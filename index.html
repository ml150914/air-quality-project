<!doctype html>
<html lang="en">
<head> <!-- meta infos about the document -->
  <meta charset="utf-8"> <!-- character encoding -->
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- adapt the page to the device's screen width. Good for mobiles -->
  <title>Air Quality – Public Dashboard</title> <!-- Title of the webpage -->

  <!-- Import external libraries and styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- Import Bootstrap CSS framework - pre build framework -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script> <!-- Parsing tool (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script> <!-- Import Chart.js library, Javascript -->
  <style>
    body{background:#f8fafc}
    .kpi .card-title{font-size:.9rem; color:#64748b}
    .kpi .display-6{font-weight:700}
  </style>
  <!-- External CSS style block. Customize the bootstrap by overrisind it
     -body{...}: background page
     .kpy .car-title{...}: Target elements with 'card-title' class inside class kpi-> smaller and grey
     .kpi .display-6{...}: Target elements with 'display-6' class inside class kpi->bold+
     KPI: Key Performace Indicator (for important metrics)  -->
</head>


<body> <!-- open the section of the HTML document seen by the users -->
<div class="container py-4"> <!-- 'container' for the contents handling the margins; 'py-4': pads the y axis of the element, 4 is the size -->
  
  <!-- Latest 60 Min -->
  <div class="dashboard-section mb-5"> <!-- Added a wrapper and margin -->
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3"> <!-- poses the childs in rational distribution -->
      <div> <!-- Title and metadata section -->
        <h1 class="h3 mb-1">AirLab Dashboard - Last 60 min</h1>
        <div class="text-muted small" id="meta1">–</div> <!-- dinamic metadata -->
      </div>
      <div class="d-flex gap-2"> <!-- Data input control: flex container with gap 2-->
        <input id="csvUrl" class="form-control" style="min-width:360px" placeholder="URL CSV (raw.githubusercontent.com)" value="https://raw.githubusercontent.com/ml150914/air-quality-project/main/data/last_60min.csv"> <!-- unique ID to the input URL (Javascript); value is a default value -->
        <button id="loadBtn" class="btn btn-primary">Load</button> <!-- button to load the data -->
      </div>
    </div>

  <!-- KPI -->
  <div class="row g-3 kpi mb-3"> <!-- horizontal row containing columns with gap 3 -->
    <div class="col-12 col-md-4"> <!-- auto-adjust with the screen dimension -->
      <div class="card shadow-sm"> <!-- color and shadow options -->
        <div class="card-body text-center"> <!-- padding inside the card with text at the center -->
          <div class="card-title">Current Value</div> <!-- label + data -->
          <div class="display-6" id="kpi-current1">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Mean</div> <!-- show the Mean of the observale-->
          <div class="display-6" id="kpi-avg1">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Min / Max</div> <!-- show the spread of the measurable -->
          <div class="display-6" id="kpi-minmax1">–</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Timestamp Column</label> <!-- Select the timestamp column -->
      <select id="timeCol1" class="form-select"></select> <!-- Select the time value to the timestamp values -->
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Observable Columns</label> <!-- Select the observable plottable -->
      <select id="valueCol1" class="form-select"></select>
    </div>
  </div>

  <div class="card shadow-sm"> <!-- Drawn the canvas -->
    <div class="card-body">
      <canvas id="chart1" height="120"></canvas> <!-- Unique identifier  -->
    </div>
  </div>
</div>

 <!-- Selected day -->
<div class="dashboard-section mb-5">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">AirLab Dashboard - Custom Day</h1>
      <div class="text-muted small" id="meta2">–</div>
    </div>
    <div class="d-flex gap-2">
      <!-- FIXED: Put option tags INSIDE the select element -->
      <select id="datasetSelect" class="form-select" style="min-width:360px">
        <option value="">-- Choose a Dataset --</option> <!-- Default prompt -->
      </select>
      <button id="loadBtn2" class="btn btn-primary">Load</button>
    </div>
  </div>


  <!-- KPI -->
  <div class="row g-3 kpi mb-3"> <!-- horizontal row containing columns with gap 3 -->
    <div class="col-12 col-md-4"> <!-- auto-adjust with the screen dimension -->
      <div class="card shadow-sm"> <!-- color and shadow options -->
        <div class="card-body text-center"> <!-- padding inside the card with text at the center -->
          <div class="card-title">Current Value</div> <!-- label + data -->
          <div class="display-6" id="kpi-current2">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Mean</div> <!-- show the Mean of the observale-->
          <div class="display-6" id="kpi-avg2">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Min / Max</div> <!-- show the spread of the measurable -->
          <div class="display-6" id="kpi-minmax2">–</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Timestamp Column</label>
      <select id="timeCol2" class="form-select"></select> <!-- Changed to timeCol2 -->
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Observable Columns</label>
      <select id="valueCol2" class="form-select"></select> <!-- Changed to valueCol2 -->
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <canvas id="chart2" height="120"></canvas> <!-- Changed to chart2 -->
    </div>
  </div>
</div>

 <!-- Last 24 Hours -->
 <div class="dashboard-section mb-5">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">AirLab Dashboard - Last 24 Hours</h1>
      <div class="text-muted small" id="meta3">–</div>
    </div>
    <div class="d-flex gap-2">
      <input id="csvUrl3" class="form-control" style="min-width:360px" placeholder="URL CSV (raw.githubusercontent.com)" value="https://raw.githubusercontent.com/ml150914/air-quality-project/main/data/last_24H.csv">
      <button id="loadBtn3" class="btn btn-primary">Load</button>
    </div>
  </div>

  <!-- KPI -->
  <div class="row g-3 kpi mb-3">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Current Value</div>
          <div class="display-6" id="kpi-current3">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Mean</div>
          <div class="display-6" id="kpi-avg3">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Min / Max</div>
          <div class="display-6" id="kpi-minmax3">–</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Timestamp Column</label>
      <select id="timeCol3" class="form-select"></select>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Observable Columns</label>
      <select id="valueCol3" class="form-select"></select>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <canvas id="chart3" height="120"></canvas>
    </div>
  </div>
</div>


<script>
  // This javascript is only for the last 60 min upload
  const els1 = {
    csvUrl: document.getElementById('csvUrl'),
    loadBtn: document.getElementById('loadBtn'),
    timeCol: document.getElementById('timeCol1'), // Fixed to timeCol1
    valueCol: document.getElementById('valueCol1'), // Fixed to valueCol1
    meta: document.getElementById('meta1'), // Fixed to meta1
    kCurr: document.getElementById('kpi-current1'), // Fixed to kpi-current1
    kAvg: document.getElementById('kpi-avg1'), // Fixed to kpi-avg1
    kMinMax: document.getElementById('kpi-minmax1'), // Fixed to kpi-minmax1
  };
  let RAW1 = [];
  let chart1;
  // Javascript for the second chart
  const els2 = {
    datasetSelect: document.getElementById('datasetSelect'),
    loadBtn: document.getElementById('loadBtn2'),
    timeCol: document.getElementById('timeCol2'), // Fixed to timeCol2
    valueCol: document.getElementById('valueCol2'), // Fixed to valueCol2
    meta: document.getElementById('meta2'), // Fixed to meta2
    kCurr: document.getElementById('kpi-current2'), // Fixed to kpi-current2
    kAvg: document.getElementById('kpi-avg2'), // Fixed to kpi-avg2
    kMinMax: document.getElementById('kpi-minmax2'), // Fixed to kpi-minmax2
  };
  let RAW2 = [];
  let chart2;

// Dashboard 3 elements - Last 24 Hours
const els3 = {
  csvUrl: document.getElementById('csvUrl3'),
  loadBtn: document.getElementById('loadBtn3'),
  timeCol: document.getElementById('timeCol3'),
  valueCol: document.getElementById('valueCol3'),
  meta: document.getElementById('meta3'),
  kCurr: document.getElementById('kpi-current3'),
  kAvg: document.getElementById('kpi-avg3'),
  kMinMax: document.getElementById('kpi-minmax3'),
};
let RAW3 = [];
let chart3;

  // Shared utility functions
  function guessTimeColumns(headers) {
    // priorità a nomi comuni
    const prefs = ['timestamp','time','datetime','date','Data','Timestamp'];
    for (const p of prefs) {
      const i = headers.findIndex(h => h.toLowerCase() === p.toLowerCase());
      if (i >= 0) return i;
    }
    // fallback: prima colonna
    return 0;
  }
  function toLabel(t){
    const d = new Date(t);
    if (!isFinite(d)) return String(t);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function numberish(x){
    const v = Number(x);
    return isFinite(v) ? v : null;
  }

  async function loadCSV(url){
    const cacheBuster = (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const res = await fetch(url + cacheBuster, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const parsed = Papa.parse(text, {header:true, dynamicTyping:false, skipEmptyLines:true});
    if (parsed.errors?.length) console.warn('CSV parse warnings:', parsed.errors);
    return parsed.data; // array di oggetti
  }

  function fillSelectors(rows, timeColEl, valueColEl){
    const headers = Object.keys(rows[0] || {});
    // Pulisci
    timeColEl.innerHTML='';
    valueColEl.innerHTML='';
    // Time
    const tIdx = guessTimeColumns(headers);
    headers.forEach((h,i)=>{
      const opt = new Option(h, h, false, i===tIdx);
      timeColEl.add(opt);
    });
    // Value (tutte, l'utente sceglie)
    headers.forEach((h,i)=>{
      const opt = new Option(h, h, false, false);
      valueColEl.add(opt);
    });
    // Se esiste una colonna con valori numerici, pre-selezionala
    for (const h of headers){
      const v = rows.find(r => numberish(r[h]) !== null);
      if (v){ valueColEl.value = h; break; }
    }
  }

  // dashboard specific render function
  function renderDashboard(RAW, timeColEl, valueColEl, kCurrEl, kAvgEl, kMinMaxEl, chartInstance, chartCanvasId){
  if (!RAW.length) {
    // Clear KPIs if no data
    kCurrEl.textContent = kAvgEl.textContent = kMinMaxEl.textContent = '–';
    return chartInstance;
  }
  
  const tKey = timeColEl.value;
  const vKey = valueColEl.value;
  
  if (!tKey || !vKey) {
    // Clear KPIs if no valid selection
    kCurrEl.textContent = kAvgEl.textContent = kMinMaxEl.textContent = '–';
    return chartInstance;
  }

  const labels = [];
  const values = [];
  for (const r of RAW){
    const t = r[tKey];
    const v = numberish(r[vKey]);
    if (t == null || v == null) continue;
    labels.push(toLabel(t));
    values.push(v);
  }

  // KPI
  if (values.length){
    const curr = values.at(-1);
    const sum = values.reduce((a,b)=>a+b,0);
    const avg = sum/values.length;
    const min = Math.min(...values);
    const max = Math.max(...values);
    kCurrEl.textContent = curr.toFixed(2);
    kAvgEl.textContent = avg.toFixed(2);
    kMinMaxEl.textContent = `${min.toFixed(2)} / ${max.toFixed(2)}`;
  } else {
    kCurrEl.textContent = kAvgEl.textContent = kMinMaxEl.textContent = '–';
  }

  // Chart handling - COMPLETELY NEW APPROACH
  try {
    const ctx = document.getElementById(chartCanvasId);
    
    // Always destroy existing chart first to avoid conflicts
    if (chartInstance && typeof chartInstance.destroy === 'function') {
      chartInstance.destroy();
    }
    
    // Create new chart with current data
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: vKey,
          data: values,
          tension: 0.3,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)'
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
    
    return chartInstance;
    
  } catch (error) {
    console.error('Error creating chart:', error);
    // Clear the canvas if chart creation fails
    const ctx = document.getElementById(chartCanvasId);
    if (ctx && ctx.getContext) {
      const context = ctx.getContext('2d');
      context.clearRect(0, 0, ctx.width, ctx.height);
    }
    return null;
  }
}


  function render1() { 
    chart1 = renderDashboard(RAW1, els1.timeCol, els1.valueCol, els1.kCurr, els1.kAvg, els1.kMinMax, chart1, 'chart1');
  }
  function render2() { 
    chart2 = renderDashboard(RAW2, els2.timeCol, els2.valueCol, els2.kCurr, els2.kAvg, els2.kMinMax, chart2, 'chart2');
  }

  // Dashboard 3 render function
  function render3() { 
    chart3 = renderDashboard(RAW3, els3.timeCol, els3.valueCol, els3.kCurr, els3.kAvg, els3.kMinMax, chart3, 'chart3');
  }


  // Dashboard specific bootstrap
  async function bootstrap1(){
    try{
      const url = els1.csvUrl.value.trim();
      RAW1 = await loadCSV(url);
      if (!RAW1.length) throw new Error('CSV vuoto');
      fillSelectors(RAW1, els1.timeCol, els1.valueCol);
      render1();
      els1.meta.textContent = `Righe: ${RAW1.length} • Sorgente: ${new URL(url).hostname}`;
    }catch(err){
      console.error(err);
      els1.meta.textContent = 'Errore: ' + err.message;
      RAW1 = [];
      render1();
    }
  }
  async function bootstrap2(){
  try{
    const selectedUrl = els2.datasetSelect.value; 
    if (!selectedUrl) {
      throw new Error('Per favore seleziona un dataset dalla lista.');
    }
    
    // Show loading state
    els2.meta.textContent = 'Caricamento...';
    
    RAW2 = await loadCSV(selectedUrl);
    if (!RAW2.length) throw new Error('CSV vuoto');
    
    fillSelectors(RAW2, els2.timeCol, els2.valueCol);
    
    // Make sure to capture the returned chart instance
    chart2 = renderDashboard(RAW2, els2.timeCol, els2.valueCol, els2.kCurr, els2.kAvg, els2.kMinMax, chart2, 'chart2');
    
    const selectedOption = els2.datasetSelect.options[els2.datasetSelect.selectedIndex];
    els2.meta.textContent = `Righe: ${RAW2.length} • Dataset: ${selectedOption.text}`;
    
  }catch(err){
    console.error('Bootstrap2 error:', err);
    els2.meta.textContent = 'Errore: ' + err.message;
    RAW2 = [];
    
    // Clear the chart and KPIs on error
    if (chart2) {
      chart2.destroy();
      chart2 = null;
    }
    els2.kCurr.textContent = els2.kAvg.textContent = els2.kMinMax.textContent = '–';
  }
}

// Dashboard 3 bootstrap function
async function bootstrap3(){
    try{
      const url = els3.csvUrl.value.trim();
      RAW3 = await loadCSV(url);
      if (!RAW3.length) throw new Error('CSV vuoto');
      fillSelectors(RAW3, els3.timeCol, els3.valueCol);
      render3();
      els3.meta.textContent = `Righe: ${RAW3.length} • Sorgente: ${new URL(url).hostname}`;
    }catch(err){
      console.error(err);
      els3.meta.textContent = 'Errore: ' + err.message;
      RAW3 = [];
      render3();
    }
  }

  async function populateDatasetDropdown() {
  const datasetSelect = document.getElementById('datasetSelect');
  const repoOwner = 'ml150914';
  const repoName = 'air-quality-project';
  const dataFolder = 'data'; // Your folder name
  
  try {
    // Show loading state
    datasetSelect.innerHTML = '<option value="">Loading datasets...</option>';
    
    // Fetch list of files from GitHub API
    const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${dataFolder}`);
    
    if (!response.ok) throw new Error('Failed to fetch dataset list');
    
    const files = await response.json();
    
    // Clear existing options
    datasetSelect.innerHTML = '<option value="">-- Choose a Dataset --</option>';
    
    // Filter and add CSV files
    files.forEach(file => {
      if (file.name.endsWith('.csv')) {
        const option = document.createElement('option');
        option.value = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${dataFolder}/${file.name}`;
        option.textContent = file.name.replace('.csv', '');
        datasetSelect.appendChild(option);
      }
    });
    
    // Auto-select the first dataset if available
    if (datasetSelect.options.length > 1) {
      datasetSelect.selectedIndex = 1;
    }
    
  } catch (error) {
    console.error('Error loading datasets:', error);
    datasetSelect.innerHTML = '<option value="">Error loading datasets</option>';
  }
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', populateDatasetDropdown);

  // Dashboard Event 1
  els1.loadBtn.addEventListener('click', bootstrap1);
  els1.timeCol.addEventListener('change', render1);
  els1.valueCol.addEventListener('change', render1);

  // Dashboard Event 2
  els2.loadBtn.addEventListener('click', bootstrap2);
  els2.timeCol.addEventListener('change', render2);
  els2.valueCol.addEventListener('change', render2);

  // Dashboard Event 3
  els3.loadBtn.addEventListener('click', bootstrap3);
  els3.timeCol.addEventListener('change', render3);
  els3.valueCol.addEventListener('change', render3);

  // Avvio con URL precompilato
  bootstrap1();
  bootstrap2();
  bootstrap3(); 

  // Auto-refresh ogni 60s (se carichi lo stesso file sovrascritto dal repo)
  setInterval(() => {
    if (!els1.csvUrl.value) return;
    bootstrap1();
    if (els3.csvUrl.value) bootstrap3(); 
  }, 60000);
</script>
</body>
</html>



