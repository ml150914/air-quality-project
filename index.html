<!doctype html>
<html lang="eng">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Air Quality – Public Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body{background:#f8fafc}
    .kpi .card-title{font-size:.9rem; color:#64748b}
    .kpi .display-6{font-weight:700}
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">AirLab Dashboard</h1>
      <div class="text-muted small" id="meta">–</div>
    </div>
    <div class="d-flex gap-2">
      <input id="csvUrl" class="form-control" style="min-width:360px" placeholder="URL CSV (raw.githubusercontent.com)" value="https://raw.githubusercontent.com/ml150914/air-quality-project/main/last_60min.csv">
      <button id="loadBtn" class="btn btn-primary">Carica</button>
    </div>
  </div>

  <!-- KPI -->
  <div class="row g-3 kpi mb-3">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Valore corrente</div>
          <div class="display-6" id="kpi-current">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Media</div>
          <div class="display-6" id="kpi-avg">–</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="card-title">Min / Max</div>
          <div class="display-6" id="kpi-minmax">–</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Colonna tempo</label>
      <select id="timeCol" class="form-select"></select>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Colonna metrica</label>
      <select id="valueCol" class="form-select"></select>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <canvas id="chart" height="120"></canvas>
    </div>
  </div>
</div>

<script>
  const els = {
    csvUrl: document.getElementById('csvUrl'),
    loadBtn: document.getElementById('loadBtn'),
    timeCol: document.getElementById('timeCol'),
    valueCol: document.getElementById('valueCol'),
    meta: document.getElementById('meta'),
    kCurr: document.getElementById('kpi-current'),
    kAvg: document.getElementById('kpi-avg'),
    kMinMax: document.getElementById('kpi-minmax'),
  };
  let RAW = [];
  let chart;

  function guessTimeColumns(headers) {
    // priorità a nomi comuni
    const prefs = ['timestamp','time','datetime','date','Data','Timestamp'];
    for (const p of prefs) {
      const i = headers.findIndex(h => h.toLowerCase() === p.toLowerCase());
      if (i >= 0) return i;
    }
    // fallback: prima colonna
    return 0;
  }
  function guessValueColumns(headers) {
    // scegli la prima colonna numerica plausibile (escludendo la time)
    const candidates = headers.map((h,i)=>({h,i}));
    return candidates; // l'utente sceglierà dal menu
  }
  function toLabel(t){
    const d = new Date(t);
    if (!isFinite(d)) return String(t);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function numberish(x){
    const v = Number(x);
    return isFinite(v) ? v : null;
  }

  async function loadCSV(url){
    const cacheBuster = (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const res = await fetch(url + cacheBuster, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const parsed = Papa.parse(text, {header:true, dynamicTyping:false, skipEmptyLines:true});
    if (parsed.errors?.length) console.warn('CSV parse warnings:', parsed.errors);
    return parsed.data; // array di oggetti
  }

  function fillSelectors(rows){
    const headers = Object.keys(rows[0] || {});
    // Pulisci
    els.timeCol.innerHTML='';
    els.valueCol.innerHTML='';
    // Time
    const tIdx = guessTimeColumns(headers);
    headers.forEach((h,i)=>{
      const opt = new Option(h, h, false, i===tIdx);
      els.timeCol.add(opt);
    });
    // Value (tutte, l'utente sceglie)
    headers.forEach((h,i)=>{
      const opt = new Option(h, h, false, false);
      els.valueCol.add(opt);
    });
    // Se esiste una colonna con valori numerici, pre-selezionala
    for (const h of headers){
      const v = rows.find(r => numberish(r[h]) !== null);
      if (v){ els.valueCol.value = h; break; }
    }
  }

  function render(){
    if (!RAW.length) return;
    const tKey = els.timeCol.value;
    const vKey = els.valueCol.value;
    if (!tKey || !vKey) return;

    const labels = [];
    const values = [];
    for (const r of RAW){
      const t = r[tKey];
      const v = numberish(r[vKey]);
      if (t == null || v == null) continue;
      labels.push(toLabel(t));
      values.push(v);
    }
    // KPI
    if (values.length){
      const curr = values.at(-1);
      const sum = values.reduce((a,b)=>a+b,0);
      const avg = sum/values.length;
      const min = Math.min(...values);
      const max = Math.max(...values);
      els.kCurr.textContent = curr.toFixed(2);
      els.kAvg.textContent = avg.toFixed(2);
      els.kMinMax.textContent = `${min.toFixed(2)} / ${max.toFixed(2)}`;
    } else {
      els.kCurr.textContent = els.kAvg.textContent = els.kMinMax.textContent = '–';
    }

    // Chart
    const ctx = document.getElementById('chart');
    const cfg = {
      type:'line',
      data:{ labels, datasets:[{ label: vKey, data: values, tension:0.3 }] },
      options:{ responsive:true, animation:false }
    };
    if (chart){ chart.data = cfg.data; chart.options = cfg.options; chart.update(); }
    else { chart = new Chart(ctx, cfg); }
  }

  async function bootstrap(){
    try{
      const url = els.csvUrl.value.trim();
      RAW = await loadCSV(url);
      if (!RAW.length) throw new Error('CSV vuoto');
      fillSelectors(RAW);
      render();
      els.meta.textContent = `Righe: ${RAW.length} • Sorgente: ${new URL(url).hostname}`;
    }catch(err){
      console.error(err);
      els.meta.textContent = 'Errore: ' + err.message;
      RAW = [];
      render();
    }
  }

  // Eventi
  els.loadBtn.addEventListener('click', bootstrap);
  els.timeCol.addEventListener('change', render);
  els.valueCol.addEventListener('change', render);

  // Avvio con URL precompilato
  bootstrap();

  // Auto-refresh ogni 60s (se carichi lo stesso file sovrascritto dal repo)
  setInterval(() => {
    if (!els.csvUrl.value) return;
    bootstrap();
  }, 60000);
</script>
</body>
</html>



